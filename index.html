<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Furniture Viewer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('styles.css');
    </style>
</head>

<body>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/4.0.0/model-viewer.min.js"></script>

    <div class="ar-container">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <div class="loading-text">Loading model...</div>
        </div>

        <!-- Top Controls -->
        <div class="top-controls">
            <div class="category-dropdown">
                <label>Category</label>
                <select class="category-select" id="category-select">
                    <option value="all">All</option>
                    <option value="sofa">Sofa</option>
                    <option value="table">Table</option>
                    <option value="bed">Bed</option>
                    <option value="chair">Chair</option>
                </select>
            </div>
            <button class="delete-btn" id="delete-btn" disabled>Delete</button>
        </div>

        <!-- Model Viewer with AR -->
        <model-viewer 
            id="room-stager" 
            src="models/sofa.glb" 
            ar 
            ar-modes="webxr scene-viewer quick-look" 
            ar-placement="floor" 
            ar-scale="fixed"
            camera-controls 
            shadow-intensity="1"
            environment-image="neutral" 
            alt="3D furniture model">

            <button slot="ar-button" id="ar-button">View in Your Room</button>
        </model-viewer>

        <!-- Current Model Badge -->
        <div class="current-model-badge" id="model-badge"></div>

        <!-- Instructions -->
        <div class="instructions" id="instructions">
            <div id="instruction-text">Scanning floor... move phone side-to-side</div>
        </div>

        <!-- Rescan Button -->
        <button class="rescan-btn" id="rescan-btn">Rescan</button>

        <!-- Toast Notification -->
        <div class="toast" id="toast"></div>

        <!-- Bottom Drawer -->
        <div class="drawer collapsed" id="drawer">
            <!-- Drawer Handle -->
            <div class="drawer-handle" id="drawer-handle">
                <div class="handle-bar"></div>
            </div>

            <!-- Furniture Categories (visible when collapsed) -->
            <div class="furniture-categories" id="furniture-categories">
                <div class="categories-title">All the furnitures depending on the category</div>
                <div class="furniture-grid" id="furniture-grid">
                    <!-- Furniture cards will be populated here -->
                </div>
            </div>

            <!-- Cart Section (visible when expanded) -->
            <div class="drawer-header">
                <h3>AR VIEW</h3>
                <p class="drawer-subtitle">Items in your cart</p>
            </div>

            <div class="cart-section">
                <div class="cart-table-header">
                    <span>Furniture Name</span>
                    <span>Copies</span>
                    <span style="text-align: right;">Cost</span>
                    <span></span>
                </div>

                <div class="cart-items" id="cart-items">
                    <div class="cart-empty">
                        <div class="cart-empty-icon">üõãÔ∏è</div>
                        <p>No items yet</p>
                    </div>
                </div>
            </div>

            <div class="cart-footer">
                <div class="total-row">
                    <span class="total-label">Total Cost</span>
                    <span class="total-amount" id="total-cost">‚Çπ0</span>
                </div>
                <div class="action-buttons">
                    <button class="action-btn btn-wishlist" id="wishlist-btn" disabled>Add to wishlist</button>
                    <button class="action-btn btn-cart" id="cart-btn" disabled>Add to cart</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Furniture Database
        const furnitureDatabase = [
            { id: 1, name: 'Modern Sofa', category: 'sofa', price: 45000, icon: 'üõãÔ∏è', model: 'models/sofa.glb' },
            { id: 2, name: 'L-Shape Sofa', category: 'sofa', price: 62000, icon: 'üõãÔ∏è', model: 'models/sofa_l.glb' },
            { id: 3, name: 'Loveseat', category: 'sofa', price: 35000, icon: 'ü™ë', model: 'models/loveseat.glb' },
            { id: 4, name: 'Dining Table', category: 'table', price: 38000, icon: 'üçΩÔ∏è', model: 'models/dining_table.glb' },
            { id: 5, name: 'Coffee Table', category: 'table', price: 12000, icon: '‚òï', model: 'models/coffee_table.glb' },
            { id: 6, name: 'Study Desk', category: 'table', price: 18000, icon: 'üìö', model: 'models/study_table.glb' },
            { id: 7, name: 'King Bed', category: 'bed', price: 55000, icon: 'üõèÔ∏è', model: 'models/king_bed.glb' },
            { id: 8, name: 'Queen Bed', category: 'bed', price: 42000, icon: 'üõèÔ∏è', model: 'models/queen_bed.glb' },
            { id: 9, name: 'Office Chair', category: 'chair', price: 15000, icon: 'ü™ë', model: 'models/office_chair.glb' },
            { id: 10, name: 'Gaming Chair', category: 'chair', price: 22000, icon: 'üéÆ', model: 'models/gaming_chair.glb' },
            { id: 11, name: 'Accent Chair', category: 'chair', price: 18000, icon: 'ü™ë', model: 'models/accent_chair.glb' },
            { id: 12, name: 'Recliner', category: 'chair', price: 28000, icon: 'ü™ë', model: 'models/recliner.glb' }
        ];

        let cart = [];
        let selectedFurniture = null;
        let currentCategory = 'all';
        const drawer = document.getElementById('drawer');
        const drawerHandle = document.getElementById('drawer-handle');
        const mv = document.getElementById('room-stager');
        const instructions = document.getElementById('instructions');
        const rescanBtn = document.getElementById('rescan-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const modelBadge = document.getElementById('model-badge');
        const deleteBtn = document.getElementById('delete-btn');
        const wishlistBtn = document.getElementById('wishlist-btn');
        const cartBtn = document.getElementById('cart-btn');
        let inAR = false;
        let drawerExpanded = false;

        // Toast notification
        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Update UI state
        function updateUIState() {
            const hasSelection = selectedFurniture !== null;
            const hasCartItems = cart.length > 0;

            deleteBtn.disabled = !hasSelection;
            wishlistBtn.disabled = !hasCartItems;
            cartBtn.disabled = !hasCartItems;
        }

        // Touch handling for drawer
        let touchStartY = 0;
        let touchCurrentY = 0;
        let isDragging = false;

        drawerHandle.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            isDragging = true;
        });

        drawerHandle.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            touchCurrentY = e.touches[0].clientY;
            const deltaY = touchCurrentY - touchStartY;

            if (Math.abs(deltaY) > 5) {
                e.preventDefault();
            }
        });

        drawerHandle.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;

            const deltaY = touchCurrentY - touchStartY;

            if (Math.abs(deltaY) > 50) {
                if (deltaY > 0) {
                    collapseDrawer();
                } else {
                    expandDrawer();
                }
            } else {
                toggleDrawer();
            }
        });

        drawerHandle.addEventListener('click', toggleDrawer);

        function toggleDrawer() {
            if (drawerExpanded) {
                collapseDrawer();
            } else {
                expandDrawer();
            }
        }

        function expandDrawer() {
            drawer.classList.remove('collapsed');
            drawer.classList.add('expanded');
            drawerExpanded = true;
        }

        function collapseDrawer() {
            drawer.classList.remove('expanded');
            drawer.classList.add('collapsed');
            drawerExpanded = false;
        }

        // Render furniture grid
        function renderFurnitureGrid() {
            const grid = document.getElementById('furniture-grid');
            const filtered = currentCategory === 'all'
                ? furnitureDatabase
                : furnitureDatabase.filter(f => f.category === currentCategory);

            grid.innerHTML = filtered.map(item => `
                <div class="furniture-card ${selectedFurniture?.id === item.id ? 'selected' : ''}" data-id="${item.id}">
                    <div class="furniture-icon">${item.icon}</div>
                    <div class="furniture-label">${item.name}</div>
                    <div class="furniture-price">‚Çπ${(item.price / 1000).toFixed(0)}k</div>
                </div>
            `).join('');

            grid.querySelectorAll('.furniture-card').forEach(card => {
                card.addEventListener('click', () => {
                    const id = parseInt(card.dataset.id);
                    selectFurniture(id);
                });
            });
        }

        // Select furniture
        function selectFurniture(id) {
            const furniture = furnitureDatabase.find(f => f.id === id);
            if (!furniture) return;

            selectedFurniture = furniture;
            changeModel(furniture.model);
            renderFurnitureGrid();
            addToCart();
            updateUIState();

            // Show model badge
            modelBadge.textContent = `Viewing: ${furniture.name}`;
            modelBadge.classList.add('show');
            setTimeout(() => {
                modelBadge.classList.remove('show');
            }, 3000);
        }

        // Render cart
        function renderCart() {
            const container = document.getElementById('cart-items');

            if (cart.length === 0) {
                container.innerHTML = `
                    <div class="cart-empty">
                        <div class="cart-empty-icon">üõãÔ∏è</div>
                        <p>No items yet</p>
                    </div>
                `;
                document.getElementById('total-cost').textContent = '‚Çπ0';
                updateUIState();
                return;
            }

            container.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div class="item-name">${item.name}</div>
                    <div class="copies-control">
                        <button class="copy-btn" onclick="updateQuantity(${item.id}, -1)">‚àí</button>
                        <span class="copy-count">${item.quantity}</span>
                        <button class="copy-btn" onclick="updateQuantity(${item.id}, 1)">+</button>
                    </div>
                    <div class="item-cost">‚Çπ${(item.price * item.quantity).toLocaleString()}</div>
                    <button class="remove-btn" onclick="removeItem(${item.id})">√ó</button>
                </div>
            `).join('');

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('total-cost').textContent = '‚Çπ' + total.toLocaleString();
            updateUIState();
        }

        // Update quantity
        window.updateQuantity = function (id, change) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.quantity = Math.max(1, item.quantity + change);
                renderCart();
            }
        };

        // Remove item
        window.removeItem = function (id) {
            cart = cart.filter(item => item.id !== id);
            if (selectedFurniture?.id === id) {
                selectedFurniture = null;
            }
            renderCart();
            renderFurnitureGrid();
            showToast('Item removed');
        };

        // Add to cart
        function addToCart() {
            if (!selectedFurniture) return;

            const existing = cart.find(item => item.id === selectedFurniture.id);
            if (existing) {
                existing.quantity++;
                showToast(`${selectedFurniture.name} quantity updated`);
            } else {
                cart.push({ ...selectedFurniture, quantity: 1 });
                showToast(`${selectedFurniture.name} added to cart`);
            }
            renderCart();
        }

        // Change model with loading state
        function changeModel(path) {
            loadingOverlay.classList.add('show');
            mv.src = path;
        }

        // Model loading events
        mv.addEventListener('load', () => {
            loadingOverlay.classList.remove('show');
        });

        mv.addEventListener('error', () => {
            loadingOverlay.classList.remove('show');
            showToast('Failed to load model', 3000);
        });

        // Event Listeners
        document.getElementById('category-select').addEventListener('change', (e) => {
            currentCategory = e.target.value;
            renderFurnitureGrid();
        });

        deleteBtn.addEventListener('click', () => {
            if (selectedFurniture) {
                removeItem(selectedFurniture.id);
            }
        });

        cartBtn.addEventListener('click', () => {
            if (cart.length > 0) {
                showToast('‚úì Items added to cart successfully!');
                // Here you would integrate with your backend/cart system
            }
        });

        wishlistBtn.addEventListener('click', () => {
            if (cart.length > 0) {
                showToast('‚ô• Items added to wishlist!');
                // Here you would integrate with your backend/wishlist system
            }
        });

        // AR Session handling
        mv.addEventListener('ar-status', (event) => {
            const started = event.detail && event.detail.status === 'session-started';
            inAR = started;

            if (started) {
                instructions.classList.add('show');
                rescanBtn.style.display = 'block';
            } else {
                instructions.classList.remove('show');
                rescanBtn.style.display = 'none';
            }
        });

        // Rescan function
        window.rescan = function () {
            document.getElementById('instruction-text').textContent = "Rescanning... find a flat surface";
        };

        rescanBtn.addEventListener('click', rescan);

        // Initialize
        renderFurnitureGrid();
        renderCart();
        updateUIState();
    </script>
</body>

</html>